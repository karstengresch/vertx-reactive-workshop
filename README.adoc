= SCENARIO

image:images/design.png["VertX Application",height=356] 

== The Micro-Homeplan Application

This is a short description of the scenario we will be working throughout the labs

Itâ€™s going to be a fake home appliance IOT management app, where we will be able to regulate the temperature in different rooms at our home. The application is composed of a set of microservices:

* The *_homeplan_* - this is a service which allows home owners to register and review their homeplan providing the temperature in each of the rooms in their house and the heat regulating applicances in each room. 

* The *_device management_* - this is a component which receives registration and update requests on the devices.

*  The *_sensor generator_* - this is a ficticious service emitting every 20 secs an event indicating the room temperature dependent on the state of the heating device (ON/OFF and INCREASING/DECREASING temperature)

* The *_homeplan regulator_* - this is a service which reads our current homeplan and based on the emmitted temperature in the room it regulates the action a device has to take to enforece the plan ie. INCREASE, DECREASE temperature of TURNOFF the device.

= LAB 4

TIME ESTIMATION 30 MINUTES
FOLLOWED by 15 MINUTES reviewing the solution

== Concepts visited in this LAB

* http://vertx.io/docs/vertx-core/java/#event_bus[The EventBus] sending/consuming messages over a clustered bus with publish pattern
* Starting multiple Verticles consuming the publish message and see what outcome of consuming is
* Use Vert.x http://vertx.io/docs/#reactive[JavaRX API]
* Observable ??





== PARTICIPANTS

==== STEP 1 - Start a clustered Vert.x application
* clone/unzip https://github.com/skoussou/vertx-reactive-workshop Branch *LAB 4*
* Run the following command to initiate a clustered Vert.X application and you should see the relevant message to indicate clustering has taken place with 4 members

----
open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/device-management
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/sensor-generator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan-regulator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"
----


==== STEP 2 - Create content for the following parts of the scenario

* Create Content for verticles in *_sensor-generator_* maven project to complete the service
  ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API] Fix method *_sendAmbianceData(DeviceStatusDTO deviceStatus, HomePlanDTO homePlan)_* to publish the generated ambiance data of a location in the house on EventBus address *_#ambiance-data_*
    *** It will be tested with the following changes

* Create Content for verticles in *_homeplan-regulator_* maven project to complete the service
  ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API] Fix method *_startHomeplanRegulatorEventBusProvider()_* to consume messages published on *_#ambiance-data_* and extract the sensor reading
     *** As soon as this is completed and saved the redeployment will result on an error to appear at the console log for *_homeplan-regulator_*

----
SEVERE: 401: HOMEPLAN_REGULATOR_FAIL_APPLY_HOMEPLANHomeplan Regulation Error
[INFO] io.vertx.core.impl.NoStackTraceThrowable: FIXME - Missing solution to send the HomePlan Regulator decision on device [SENSOR-LOCATION-DEVICE-ID]
----

   ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API]  Fix method *_sendRegulatoryMsg_* to generate a message  which can be delivered to *_#device-action_* EventBus address to signify different actions on a device INCREASING/DECREASING/TURNOFF. 
     *** TESTS
        **** Use the tests below and follow logs to see that the temperature increases/decreases depending on PLAN and sensor data
        **** Ensure device is turned-off when homeplan temperature in that sensorLocation is reached
        **** Change homeplan via a modification of test3.json and resubmit via PUT Rest request on the same endpoint
        **** Start homeplan-regulator Verticle with --instances=2 parameter ---> What happens? does homeplan-regulator Verticle instances both consume it? (It shouldn't be, it should be one)
        **** Start an additional homeplan-regulator Verticle with  ---> What happens? does homeplan-regulator Verticle instances both consume it? (It shouldn't be, it should be one)
----
open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/device-management
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/sensor-generator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan/data
url -H "Content-Type: application/json" -X POST -d '@test3.json'  http://127.0.0.1:8080/homeplan/test3
----

==== STEP 3 - Modify Content to utilize Vert.x JavaRX API

*TBD*

