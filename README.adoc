= SCENARIO

image:images/design.png["VertX Application",height=356] 

== The Micro-Homeplan Application

This is a short description of the scenario we will be working throughout the labs

Itâ€™s going to be a fake home appliance IOT management app, where we will be able to regulate the temperature in different rooms at our home. The application is composed of a set of microservices:

* The *_homeplan_* - this is a service which allows home owners to register and review their homeplan providing the temperature in each of the rooms in their house and the heat regulating applicances in each room. 

* The *_device management_* - this is a component which receives registration and update requests on the devices.

*  The *_sensor generator_* - this is a ficticious service emitting every 20 secs an event indicating the room temperature dependent on the state of the heating device (ON/OFF and INCREASING/DECREASING temperature)

* The *_homeplan regulator_* - this is a service which reads our current homeplan and based on the emmitted temperature in the room it regulates the action a device has to take to enforece the plan ie. INCREASE, DECREASE temperature of TURNOFF the device.

= LAB 5

TIME ESTIMATION 30 MINUTES
FOLLOWED by 15 MINUTES reviewing the solution

== Concepts visited in this LAB

* fabric8-maven-plugin
* Build & Deploy on OCP (deployment.yaml)
* Clustering Bridge on Kubernetes
* Vert.x service discovery on OCP (KubernetesBridge)


  
ORGANIZERS PART
clone/unzip "ReactiveVertX Branch - LAB 4"
ALL Projects now should be OCP Ready (fabric8-maven-plugin etc.)  APART from Homeplan Regulator

AUTONOMOUS : CHECK
ASYNCHRONOUS: CHECK
ELASTIC: NOT
RESILIENT: NOT

PARTICIPANTS PART
Walk them through (descriptive) settting up Homeplan Regulator MAVEN project for OCP deployment with
 - fabric8-maven-
use fabric8 plugin (show them something??)
  - build (how and why??)
  - deploy (show them if you want custom deploymentConfig)

clustering config in our projects (TBD) maybe dependencies and cluster manager configurationa and maybe separating groups 

Scale components HomePlan Regulator using OC Commands (eg. Sensor Generator messages consumed by multiple HomePlan Regulaotrs or ONLY one??)

TESTS:
    



== PARTICIPANTS

==== STEP 1 - Start a clustered Vert.x application
* clone/unzip https://github.com/skoussou/vertx-reactive-workshop Branch *LAB 4*
* Run the following command to initiate a clustered Vert.X application and you should see the relevant message to indicate clustering has taken place with 4 members

----
open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/device-management
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/sensor-generator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan-regulator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"
----


==== STEP 2 - Create content for the following parts of the scenario

* Create Content for verticles in *_sensor-generator_* maven project to complete the service
  ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API] Fix method *_sendAmbianceData(DeviceStatusDTO deviceStatus, HomePlanDTO homePlan)_* to publish the generated ambiance data of a location in the house on EventBus address *_#ambiance-data_*
    *** It will be tested with the following changes

* Create Content for verticles in *_homeplan-regulator_* maven project to complete the service
  ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API] Fix method *_startHomeplanRegulatorEventBusProvider()_* to consume messages published on *_#ambiance-data_* and extract the sensor reading
     *** As soon as this is completed and saved the redeployment will result on an error to appear at the console log for *_homeplan-regulator_*

----
SEVERE: 401: HOMEPLAN_REGULATOR_FAIL_APPLY_HOMEPLANHomeplan Regulation Error
[INFO] io.vertx.core.impl.NoStackTraceThrowable: FIXME - Missing solution to send the HomePlan Regulator decision on device [SENSOR-LOCATION-DEVICE-ID]
----

   ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API]  Fix method *_sendRegulatoryMsg_* to generate a message  which can be delivered to *_#device-action_* EventBus address to signify different actions on a device INCREASING/DECREASING/TURNOFF. 

----
open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/device-management
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/sensor-generator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-3]/homeplan/data
url -H "Content-Type: application/json" -X POST -d '@test3.json'  http://127.0.0.1:8080/homeplan/test3
----

     ====== TESTS
        **** Test 1: Use the tests above and follow logs to see that the temperature increases/decreases depending on PLAN and sensor data. See an indicative log below and notice the homeplan 
