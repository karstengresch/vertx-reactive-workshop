= SCENARIO

image:images/design.png["VertX Application",height=356] 

== The Micro-Homeplan Application

This is a short description of the scenario we will be working throughout the labs

Itâ€™s going to be a fake home appliance IOT management app, where we will be able to regulate the temperature in different rooms at our home. The application is composed of a set of microservices:

* The *_homeplan_* - this is a service which allows home owners to register and review their homeplan providing the temperature in each of the rooms in their house and the heat regulating applicances in each room. 

* The *_device management_* - this is a component which receives registration and update requests on the devices.

* The *_sensor generator_* - this is a ficticious service emitting every 20 secs an event indicating the room temperature dependent on the state of the heating device (ON/OFF and INCREASING/DECREASING temperature)

* The *_homeplan regulator_* - this is a service which reads our current homeplan and based on the emmitted temperature in the room it regulates the action a device has to take to enforece the plan ie. INCREASE, DECREASE temperature of TURNOFF the device.


= LAB 1

TIME ESTIMATION 30 MINUTES
FOLLOWED by 15 MINUTES explain the solution


== Concepts in this LAB

- Verticle and instances
- HTTPServer
- EventLoop
- Launcher

== Organizers

. STEP 1     (ALL steps/names provided) Creatd a vertx project (using mvn archetype) 

[source,perl]
----
mvn io.fabric8:vertx-maven-plugin:1.0.9:setup -DprojectGroupId=com.redhat.consulting.vertx -DprojectArtifactId=homeplan -Dverticle=com.redhat.consulting.vertx.MainVerticle -Ddependencies=web
----
. STEP 2      (ALL steps/names provided) Review Verticle 
                 .. create a HelloWorld HTTP SERVER
                 ..  TEST IT
                 .. check EXTEND, check pom.xml etc.
. STEP 3      REAL LAB : generate the HTTP server & Use ROUTER to define the endpoints
     - (US) provide a method to get/save the HomePlan into the shared data a LOCAL Varaibale
     - (US) provide a dummy method for "send device reg event"
     - (US) Hoe to encode/decode JSON??
     - (US) Objects

* as an extra show  DURING last 15 minutes 
* how to start multiple Verticle Instances and what it means from HTTP 
* Request handling (Event Loop, Verticle Instance)

== Participants


[source,perl]

==== STEP 1 - Create a Vert.X maven project wit the following command initiating it with a single Vert.X Verticle using a Vert.X maven archetype

[source,perl]
----
mvn io.fabric8:vertx-maven-plugin:1.0.9:setup -DprojectGroupId=com.redhat.consulting.vertx -DprojectArtifactId=homeplan -Dverticle=com.redhat.consulting.vertx.MainVerticle -Ddependencies=web
----

    - Inspect MainVerticle.java and the AbstractVerticle to identify getting access to the Vertx instance
    - Start the Vert.X eventloop locally with the following command accessing in the end http://127.0.0.1:8080 for the default implementaiton
      [source,perl]
      ----
      mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"
      ----

====  STEP 2 In this step you will create an HTTP server and expose *_homeplan_* service endpoints
  . *(TBD: Look AT LINK)* and create an HTTP server so that it exposes the services in port 8181 in the *_start()_* method of the MainVerticle.java
  . Add logging into the MainVerticle.java choosing the */io.vertx.core.*_* logging imports
   
[source,perl]
----
private final Logger logger = LoggerFactory.getLogger(MainVerticle.class);
----

  . Create a member variable to hold submitted Homeplans 
      
[source,perl]
----
private Map<String, String> homeplans= new HashMap<String, Map<String, List<String>>>();
---- 
  . *(TBD: Look AT LINK)* and implement the following REST endpoints on the HTTP Server created previously
      .. Expose a *GET* operation on endpoint *_/homeplan_* to be handled by the method *_getAll_* (provided for you in the following code snipet)

[source,perl]
----
private void getAll(RoutingContext routingContext) {
logger.info("Getting all homeplan ids available");
          String [] dummyIds = new String[]{"KousourisHousePlan", "SanchoHousePlan"};
          logger.info("Returning Dummy Homeplan IDs ", Json.encodePrettily(dummyIds));
						routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
								.end(Json.encodePrettily(dummyIds));
}
----

      *TEST*

[source,perl]
----
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

On a browser
http://127.0.0.0:8181/homeplan
----
       
      .. Expose a *GET* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_getOne_* (provided for you in the following code snipet) returning a single HomePlan)

[source,perl]
----
private void getOne(RoutingContext routingContext) {
                if (homeplans.get(routingContext.pathParam(Constants.ID_PARAM) != null) {
		    routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
						.end(Json.encodePrettily(homeplans.get(routingContext.pathParam(Constants.ID_PARAM))));
		} else {
                    routingContext.fail(404);
		}
      }
----

      *TEST*

[source,perl]
----
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"
On a browser
http://127.0.0.0:8181/homeplan/KousourisHouseplan
----

      .. Expose a *POST* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_getOne_* (provided for you in the following code snipet) updating a single HomePlan)

[source,perl]
----
private void addOne(RoutingContext routingContext) {
                final String homeplanId = routingContext.pathParam(Constants.ID_PARAM);
		final String homePlan = (List<String) Json.decodeValue(routingContext.getBodyAsString(), String.class);

                homePlans.put(homeplanId, homePlan);

                logger.info("Sending event to address {0} to register devices", Constants.DEVICE_REGISTRATION_EVENTS_ADDRESS);
}
----

      *TEST*

[source,perl]
----
curl -d "@testA.json" -X POST http://127.0.0.0:8181/homeplan/KousourisHouseplan

testA.json CONTENTS
{ "\"sensorLocations\" : [{[\"kitchen\", \"kitchen-1\", \"22\"]}, {[\"bedroom\", \"bedroom-1\", \"23\"]}], \"devices\" : [{[\"AIRCON\", \"kitchen-1\"]}, {[\"AIRCON\", \"bedroom-1\"]}]"  }
----

      .. Expose a *PUT* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_addOne_* (provided for you in the above code snipet) updating a single HomePlan)

      *TEST*

----
curl -d "@testB.json" -X PUT http://127.0.0.0:8181/homeplan/KousourisHouseplan

testB.json CONTENTS
{ "\"sensorLocations\" : [{[\"kitchen\", \"kitchen-1\", \"30\"]}, {[\"bedroom\", \"bedroom-1\", \"35\"]}], \"devices\" : [{[\"AIRCON\", \"kitchen-1\"]}, {[\"AIRCON\", \"bedroom-1\"]}]"  }
----
      
All of the above will require the following class


----
     public class Constants {

	// Rest
	//public static final String ROOT_PATH = "/homeplan";
	public static final String ROOT_PATH = "/";

	public static final String ID_PARAM = "id";

	// Share data
	public static final String HOMEPLANS_MAP = "homeplans";

	public static final String HOMEPLAN_IDS_MAP = "homeplan-ids";

	public static final String SET_ID = "index-set-id";

	// Addresses
	public static final String DEVICE_REGISTRATION_EVENTS_ADDRESS = "device-reg";
	
	public static final String HOMEPLANS_EVENTS_ADDRESS = "homeplans";
	
	public static final String DEVICE_DATA_EVENTS_ADDRESS = "device-data";
     }
----

. HTTP Server & simple service calling (problem not-reactive as not resillient/scalable)
    .. Create Content for verticles in HomePlan
    ..  [REST] [GET] /homeplan/{id}
    ..  [REST] [POST/PUT/GET] /homeplan 
. TESTS
Run Vert.X outside OCP with vertx-maven-plugin
[source,perl]
----
  mvn compile vertx:run"
----

   . REGISTER Homeplan
   . GET all IDs of Homeplans Registred
   . GET Homeplan by ID
   . UPDATE Homeplan

     Run outside OCP
     Pre-Requisites: send device-reg message (we provide dummy console log output)

= LAB 2

= LAB 3

= LAB 4

= LAB 5

