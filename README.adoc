= SCENARIO

image:images/design.png["VertX Application",height=356] 

== The Micro-Homeplan Application

This is a short description of the scenario we will be working throughout the labs

Itâ€™s going to be a fake home appliance IOT management app, where we will be able to regulate the temperature in different rooms at our home. The application is composed of a set of microservices:

* The *_homeplan_* - this is a service which allows home owners to register and review their homeplan providing the temperature in each of the rooms in their house and the heat regulating applicances in each room. 

* The *_device management_* - this is a component which receives registration and update requests on the devices.

* The *_sensor generator_* - this is a ficticious service emitting every 20 secs an event indicating the room temperature dependent on the state of the heating device (ON/OFF and INCREASING/DECREASING temperature)

* The *_homeplan regulator_* - this is a service which reads our current homeplan and based on the emmitted temperature in the room it regulates the action a device has to take to enforece the plan ie. INCREASE, DECREASE temperature of TURNOFF the device.


= LAB 1

TIME ESTIMATION 30 MINUTES
FOLLOWED by 15 MINUTES explain the solution


== Concepts in this LAB

- Verticle and instances
- HTTPServer
- EventLoop
- Launcher


== Participants


[source,perl]

==== STEP 1 - Create a Vert.X maven project wit the following command initiating it with a single Vert.X Verticle using a Vert.X maven archetype

[source,perl]
----
mvn io.fabric8:vertx-maven-plugin:1.0.9:setup -DprojectGroupId=com.redhat.consulting.vertx -DprojectArtifactId=homeplan -Dverticle=com.redhat.consulting.vertx.MainVerticle -Ddependencies=web
----

    - Inspect *_MainVerticle.java_* and the AbstractVerticle to identify getting access to the Vertx instance
    - Start the Vert.X eventloop locally with the following command and check the logs to ensure the Verticle has been successfully started

[source,perl]
----
mvn compile vertx:run
----

    - Make a change on *_MainVerticle.java_* and press 'Save'. You will see in the command line the *_vertx-maven-plugin_* fabric8 plugin redeploying the verticle


====  STEP 2 In this step you will create an HTTP server and expose *_homeplan_* service endpoints
* *(TBD: Look AT LINK)* and create an HTTP server so that it exposes the services in port 8181 in the *_start()_* method of the MainVerticle.java
  ** As a final step expose a "Hello World" message on a GET request to the *_/_* path of the HTTP server
  ** *TEST* After the Verticle Redeployment hit http://127.0.0.0:8181/ and you should see "Hello World" returned

* Add logging into the *_MainVerticle.java_* choosing the *_io.vertx.core.*;_* logging imports
   
[source,perl]
----
private final Logger logger = LoggerFactory.getLogger(MainVerticle.class);
----

* Create a member variable to hold submitted Homeplans 
      
[source,perl]
----
private Map<String, String> homeplans= new HashMap<String, String>();
---- 

* *(TBD: Look AT LINK)* and implement the following REST endpoints on the HTTP Server created previously
      ** Expose a *GET* operation on endpoint *_/homeplan_* to be handled by the method *_getAll_* (provided for you in the following code snipet) to retrieve all registerd homeplan IDs

[source,perl]
----
    private void getAll(RoutingContext routingContext) {
    	logger.info("Getting all homeplan ids available");

    	if (homeplans.keySet().size() != 0){
    		logger.info("Returning Homeplan IDs ", Json.encodePrettily(homeplans.keySet()));
        	routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
        	.end(Json.encodePrettily(homeplans.keySet()));
    	} else {
    		logger.info("No Homeplans Registered as yet");
        	routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
        	.end(Json.encodePrettily("No Homeplans Registered as yet"));
    	}
    }
----

*TEST*

[source,perl]
----
mvn compile vertx:run

On a browser
http://127.0.0.0:8181/homeplan
----
       
      ** Expose a *GET* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_getOne_* (provided for you in the following code snipet) returning the contents of a single HomePlan (Note: utilize Constants.ID_PARAM)

[source,perl]
----
    private void getOne(RoutingContext routingContext) {
    	if (homeplans.get(routingContext.pathParam(Constants.ID_PARAM)) != null) {
    		routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
    		.end(Json.encodePrettily(homeplans.get(routingContext.pathParam(Constants.ID_PARAM))));
    	} else {
    		routingContext.fail(404);
    	}
    
----

*TEST*

[source,perl]
----
mvn compile vertx:run

On a browser
http://127.0.0.0:8181/homeplan/KousourisHouseplan
----

      ** Expose a *POST* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_getOne_* (provided for you in the following code snipet) registering a single HomePlan

[source,perl]
----
    private void addOne(RoutingContext routingContext) {
    	final String homeplanId = routingContext.pathParam(Constants.ID_PARAM);
    	final String homePlan = routingContext.getBodyAsString();
	
    	homeplans.put(homeplanId, homePlan);

    	logger.info("Registering Homeplan ["+homeplanId+"] with content ["+homePlan+"]");
    	
    	logger.info("Sending event to address #{0} to register devices", Constants.DEVICE_REGISTRATION_EVENTS_ADDRESS);
    	
    	routingContext.response().setStatusCode(201)
		.putHeader("content-type", "application/json; charset=utf-8")
		.end(Json.encodePrettily(homePlan));
    }
----

*TEST*


----
mvn compile vertx:run
curl -H "Content-Type: application/json" -X POST -d '@sanchoA.json'  http://127.0.0.1:8181/homeplan/Sancho

sanchoA.json CONTENTS
{ "SanschoHomePlan" : [{ "sensorLocations" : ["kitchen", "kitchen-1", "22"], "devices" : ["AIRCON", "kitchen-1"]}, { "sensorLocations" : ["bedroom", "bedroom-1", "23"], "devices" : ["AIRCON", "bedroom-1"]}]}

----

      ** Expose a *PUT* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_addOne_* (provided for you in the above code snipet) updating a single HomePlan

*TEST*

----
mvn compile vertx:run
curl -H "Content-Type: application/json" -X PUT -d '@sanchoB.json'  http://127.0.0.1:8181/homeplan/Sancho

testB.json CONTENTS
{ "SanschoHomePlan" : [{ "sensorLocations" : ["kitchen", "kitchen-1", "30"], "devices" : ["AIRCON", "kitchen-1"]}, { "sensorLocations" : ["bedroom", "bedroom-1", "33"], "devices" : ["AIRCON", "bedroom-1"]}]}
----
      
All of the above will require the following class


----
     public class Constants {

	// Rest
	//public static final String ROOT_PATH = "/homeplan";
	public static final String ROOT_PATH = "/";

	public static final String ID_PARAM = "id";

	// Share data
	public static final String HOMEPLANS_MAP = "homeplans";

	public static final String HOMEPLAN_IDS_MAP = "homeplan-ids";

	public static final String SET_ID = "index-set-id";

	// Addresses
	public static final String DEVICE_REGISTRATION_EVENTS_ADDRESS = "device-reg";
	
	public static final String HOMEPLANS_EVENTS_ADDRESS = "homeplans";
	
	public static final String DEVICE_DATA_EVENTS_ADDRESS = "device-data";
     }
----


====  STEP 3 Threading, Event Loop instances


* as an extra show  DURING last 15 minutes 
* how to start multiple Verticle Instances and what it means from HTTP 
* Request handling (Event Loop, Verticle Instance)



